<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.bat.service.BatchManagementMapper">

    <!-- 잡 이름 목록 조회 -->
    <select id="selectJobNames" resultType="string">
        SELECT DISTINCT JOB_NAME
        FROM BATCH_JOB_INSTANCE
        ORDER BY JOB_NAME
    </select>

    <!-- 특정 잡의 실행 이력 조회 -->
    <resultMap id="jobExecutionMap" type="egovframework.bat.service.dto.JobExecutionDto">
        <id property="id" column="JOB_EXECUTION_ID"/>
        <result property="startTime" column="START_TIME"/>
        <result property="endTime" column="END_TIME"/>
        <result property="status" column="STATUS"/>
        <result property="exitCode" column="EXIT_CODE"/>
        <result property="exitDescription" column="EXIT_MESSAGE"/>
        <result property="createTime" column="CREATE_TIME"/>
        <result property="lastUpdated" column="LAST_UPDATED"/>
    </resultMap>

    <select id="selectJobExecutions" parameterType="string" resultMap="jobExecutionMap">
        SELECT
            JE.JOB_EXECUTION_ID,
            JE.START_TIME,
            JE.END_TIME,
            JE.STATUS,
            JE.EXIT_CODE,
            JE.EXIT_MESSAGE,
            JE.CREATE_TIME,
            JE.LAST_UPDATED
        FROM BATCH_JOB_EXECUTION JE
        JOIN BATCH_JOB_INSTANCE JI ON JE.JOB_INSTANCE_ID = JI.JOB_INSTANCE_ID
        WHERE JI.JOB_NAME = #{jobName}
        ORDER BY JE.JOB_EXECUTION_ID DESC
    </select>

    <!-- 에러 로그 조회 -->
    <select id="selectErrorLogs" parameterType="long" resultType="string">
        SELECT SE.EXIT_MESSAGE
        FROM BATCH_STEP_EXECUTION SE
        WHERE SE.JOB_EXECUTION_ID = #{jobExecutionId}
          AND SE.EXIT_MESSAGE IS NOT NULL
    </select>

</mapper>
