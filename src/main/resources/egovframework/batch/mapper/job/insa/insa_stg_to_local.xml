<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="insaStgToLoc">

        <!-- 조직 정보 목록 조회 -->
        <select id="selectOrgnztList" resultType="egovframework.bat.job.insa.domain.Orgnztinfo">
                SELECT
                         ORGNZT_ID,
                         ORGNZT_NM,
                         ORGNZT_DC
                FROM migstg.COMTNORGNZTINFO
        </select>

        <!-- STG DB에서 로컬 DB로 이관할 사원 목록 조회 -->
        <select id="selectEmployeeList" resultType="egovframework.bat.job.insa.domain.EmployeeInfo">
                SELECT
                         ESNTL_ID,
                         EMPLYR_ID,
                         ORGNZT_ID,
                         USER_NM,
                         SEXDSTN_CODE,
                         BRTHDY,
                         MBTLNUM,
                         EMAIL_ADRES,
                         OFCPS_NM,
                         EMPLYR_STTUS_CODE,
                         REG_DTTM,
                         MOD_DTTM
                FROM migstg.COMTNEMPLYRINFO
        </select>

        <!-- EMPLYR_ID를 기준으로 기존 사원 정보를 갱신 -->
        <update id="updateEmployee">
                UPDATE egovlocal.COMTNEMPLYRINFO u
                JOIN migstg.COMTNEMPLYRINFO s ON u.EMPLYR_ID = s.EMPLYR_ID
                SET u.EMPLYR_ID = s.EMPLYR_ID,
                    u.USER_NM = s.USER_NM,
                    u.ORGNZT_ID = s.ORGNZT_ID,
                    u.SEXDSTN_CODE = s.SEXDSTN_CODE,
                    u.BRTHDY = s.BRTHDY,
                    u.MBTLNUM = s.MBTLNUM,
                    u.EMAIL_ADRES = s.EMAIL_ADRES,
                    u.OFCPS_NM = s.OFCPS_NM,
                    u.EMPLYR_STTUS_CODE = s.EMPLYR_STTUS_CODE,
                    u.REG_DTTM = s.REG_DTTM,
                    u.MOD_DTTM = s.MOD_DTTM
        </update>

       <!-- 신규 사원 추가 전에 ESNTL_ID 시퀀스 초기화 -->
       <update id="initEmployeeSeq">
               SET @seq := (
                 SELECT MAX(CAST(SUBSTR(ESNTL_ID, 4) AS UNSIGNED))
                 FROM egovlocal.COMTNEMPLYRINFO
               )
       </update>

       <!-- STG에만 존재하는 사원을 로컬 DB에 신규 추가 -->
       <insert id="insertEmployeeIncremental">
               INSERT INTO egovlocal.COMTNEMPLYRINFO (ESNTL_ID, EMPLYR_ID, ORGNZT_ID, USER_NM, SEXDSTN_CODE, BRTHDY, MBTLNUM, EMAIL_ADRES, OFCPS_NM, EMPLYR_STTUS_CODE, REG_DTTM, MOD_DTTM)
               SELECT CONCAT('LND', LPAD(@seq := @seq + 1, 7, '0')) AS ESNTL_ID,
                      s.EMPLYR_ID, s.ORGNZT_ID, s.USER_NM, s.SEXDSTN_CODE, s.BRTHDY, s.MBTLNUM, s.EMAIL_ADRES, s.OFCPS_NM, s.EMPLYR_STTUS_CODE, s.REG_DTTM, s.MOD_DTTM
               FROM migstg.COMTNEMPLYRINFO s
               LEFT JOIN egovlocal.COMTNEMPLYRINFO u ON u.ESNTL_ID = s.ESNTL_ID
               WHERE u.ESNTL_ID IS NULL
       </insert>

        <!-- 로컬 DB에 조직 정보 적재 -->
        <insert id="insertOrganization" parameterType="egovframework.bat.job.insa.domain.EmployeeInfo">
                INSERT INTO egovlocal.COMTNORGNZTINFO (ORGNZT_ID, ORGNZT_NM, ORGNZT_DC)
                                VALUES (#{orgnztId}, #{orgnztNm}, #{orgnztDc})
                        ON DUPLICATE KEY UPDATE
                                ORGNZT_NM = VALUES(ORGNZT_NM),
                                ORGNZT_DC = VALUES(ORGNZT_DC)
        </insert>

        <!-- STG -> Local 이관 시 사용 (ESNTL_ID 포함) -->
        <insert id="insertEmployee" parameterType="egovframework.bat.job.insa.domain.EmployeeInfo">
                INSERT INTO egovlocal.COMTNEMPLYRINFO
                        (ESNTL_ID, EMPLYR_ID, ORGNZT_ID, USER_NM, SEXDSTN_CODE, BRTHDY, MBTLNUM, EMAIL_ADRES, OFCPS_NM, EMPLYR_STTUS_CODE, REG_DTTM, MOD_DTTM)
                VALUES
                        (#{esntlId}, #{emplyrId}, #{orgnztId}, #{userNm}, #{sexdstnCode}, #{brthdy}, #{mbtlnum}, #{emailAdres}, #{ofcpsNm}, #{emplyrSttusCode}, #{regDttm}, #{modDttm})
        </insert>

</mapper>
