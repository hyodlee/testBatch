<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="riskStgToLoc">

    <!-- STG의 리스크 카테고리 목록 조회 -->
    <select id="selectCategoryList" resultType="egovframework.bat.job.risk.domain.RiskCategory">
        SELECT
            CATEGORY_ID,
            CATEGORY_NAME,
            CATEGORY_DESC AS categoryDescription
        FROM migstg.RISK_CATEGORY
    </select>

    <!-- STG의 리스크 사건 목록 조회 -->
    <select id="selectIncidentList" resultType="egovframework.bat.job.risk.domain.RiskIncident">
        SELECT
            INCIDENT_ID,
            INCIDENT_NO,
            CATEGORY_ID,
            TITLE,
            RISK_LEVEL,
            STATUS,
            OWNER_ID,
            DESCRIPTION,
            OCCURRED_AT,
            UPDATED_AT
        FROM migstg.RISK_INCIDENT
    </select>

    <!-- 기존 로컬 사건 정보 갱신 -->
    <update id="updateIncident">
        UPDATE egovlocal.RISK_INCIDENT u
        JOIN migstg.RISK_INCIDENT s ON u.INCIDENT_NO = s.INCIDENT_NO
        SET u.CATEGORY_ID = s.CATEGORY_ID,
            u.TITLE = s.TITLE,
            u.RISK_LEVEL = s.RISK_LEVEL,
            u.STATUS = s.STATUS,
            u.OWNER_ID = s.OWNER_ID,
            u.DESCRIPTION = s.DESCRIPTION,
            u.OCCURRED_AT = s.OCCURRED_AT,
            u.UPDATED_AT = s.UPDATED_AT
    </update>

    <!-- INCIDENT_ID 시퀀스 초기화 -->
    <update id="initIncidentSeq">
        SET @riskSeq := (
            SELECT IFNULL(MAX(CAST(SUBSTR(INCIDENT_ID, 4) AS UNSIGNED)), 0)
            FROM egovlocal.RISK_INCIDENT
        )
    </update>

    <!-- 신규 리스크 사건 적재 -->
    <insert id="insertIncidentIncremental">
        INSERT INTO egovlocal.RISK_INCIDENT (
            INCIDENT_ID,
            INCIDENT_NO,
            CATEGORY_ID,
            TITLE,
            RISK_LEVEL,
            STATUS,
            OWNER_ID,
            DESCRIPTION,
            OCCURRED_AT,
            UPDATED_AT)
        SELECT CONCAT('RSK', LPAD(@riskSeq := @riskSeq + 1, 7, '0')) AS INCIDENT_ID,
               s.INCIDENT_NO,
               s.CATEGORY_ID,
               s.TITLE,
               s.RISK_LEVEL,
               s.STATUS,
               s.OWNER_ID,
               s.DESCRIPTION,
               s.OCCURRED_AT,
               s.UPDATED_AT
        FROM migstg.RISK_INCIDENT s
        LEFT JOIN egovlocal.RISK_INCIDENT u ON u.INCIDENT_NO = s.INCIDENT_NO
        WHERE u.INCIDENT_NO IS NULL
    </insert>

    <!-- 로컬 리스크 카테고리 적재 -->
    <insert id="insertCategory" parameterType="egovframework.bat.job.risk.domain.RiskCategory">
        INSERT INTO egovlocal.RISK_CATEGORY (CATEGORY_ID, CATEGORY_NAME, CATEGORY_DESC)
        VALUES (#{categoryId}, #{categoryName}, #{categoryDescription})
        ON DUPLICATE KEY UPDATE
            CATEGORY_NAME = VALUES(CATEGORY_NAME),
            CATEGORY_DESC = VALUES(CATEGORY_DESC)
    </insert>

    <!-- STG 데이터를 로컬 사건 테이블에 직접 적재 (필요 시 사용) -->
    <insert id="insertIncident" parameterType="egovframework.bat.job.risk.domain.RiskIncident">
        INSERT INTO egovlocal.RISK_INCIDENT (
            INCIDENT_ID,
            INCIDENT_NO,
            CATEGORY_ID,
            TITLE,
            RISK_LEVEL,
            STATUS,
            OWNER_ID,
            DESCRIPTION,
            OCCURRED_AT,
            UPDATED_AT)
        VALUES (
            #{incidentId},
            #{incidentNo},
            #{categoryId},
            #{title},
            #{riskLevel},
            #{status},
            #{ownerId},
            #{description},
            #{occurredAt},
            #{updatedAt})
    </insert>

</mapper>
